<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LSF Turbo V3</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; background-color: #000;
            width: 100vw; height: 100vh; font-family: sans-serif;
            display: flex; justify-content: center; align-items: center;
        }

        /* VID√âO FLUIDE (Hardware Accelerated) */
        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: rotateY(180deg); z-index: 1;
        }

        /* CANVAS INVISIBLE (Sert uniquement aux calculs AI) */
        canvas { display: none; }

        /* INTERFACE TEXTE */
        .hud {
            position: absolute; bottom: 15%; width: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; pointer-events: none;
        }

        .bubble {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 15px 40px; border-radius: 40px;
            border: 2px solid #3b82f6; transition: border-color 0.2s;
        }

        .word {
            color: white; font-size: 2.5rem; font-weight: 900;
            text-transform: uppercase; margin: 0;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .fps-counter {
            position: absolute; top: 10px; left: 10px; z-index: 20;
            color: lime; font-weight: bold; font-family: monospace;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div class="fps-counter" id="fps">FPS: 0</div>

    <video id="webcam" playsinline muted autoplay></video>
    
    <canvas id="ai_canvas"></canvas>

    <div class="hud">
        <div class="bubble" id="bubble-box">
            <h1 class="word" id="word-out">...</h1>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('ai_canvas');
        const ctx = canvas.getContext('2d');
        const wordOut = document.getElementById('word-out');
        const bubbleBox = document.getElementById('bubble-box');
        const fpsText = document.getElementById('fps');

        let lastDetected = "";
        let detectionStart = 0;
        let lastFrameTime = 0;
        const HOLD_TIME = 500; // 0.5s pour valider (tr√®s r√©actif)

        // 1. CONFIGURATION AI
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0, // Mode Ultra Rapide
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            // Calcul FPS
            const now = Date.now();
            const fps = 1000 / (now - lastFrameTime);
            lastFrameTime = now;
            fpsText.innerText = `FPS: ${Math.round(fps)}`;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                let word = analyzeGesture(lm);
                display(word);
            } else {
                display("");
            }
        });

        // 2. LOGIQUE INTELLIGENTE (8 MOTS)
        function analyzeGesture(lm) {
            // lm[8] = Index, lm[0] = Poignet
            // Y: 0 (Haut) -> 1 (Bas)
            
            const y = lm[8].y;
            const fingers = countFingers(lm);
            const thumbOpen = isThumbOpen(lm);

            // --- GESTES GLOBAUX (N'importe o√π) ---
            
            // POUCE EN L'AIR (Seul le pouce est ouvert)
            if (fingers === 0 && thumbOpen && lm[4].y < lm[3].y) return "OUI üëç";

            // V DE LA VICTOIRE
            if (fingers === 2 && !thumbOpen && lm[8].y < lm[6].y && lm[12].y < lm[10].y) return "√áA VA ? ‚úåÔ∏è";

            // --- ZONE HAUTE (Visage) ---
            if (y < 0.45) {
                // T√âL√âPHONE (Pouce + Petit doigt seulement)
                const pinkyUp = lm[20].y < lm[18].y;
                if (thumbOpen && pinkyUp && fingers === 1) return "T√âL√âPHONE ü§ô";

                // BONJOUR (Main ouverte)
                if (fingers >= 3) return "BONJOUR üëã";

                // MANGER (Pince ferm√©e)
                if (fingers <= 2 && !pinkyUp && !thumbOpen) return "MANGER üçé";
            }

            // --- ZONE BASSE (Torse) ---
            else if (y > 0.50) {
                // MOI (Index seul)
                if (fingers === 1 && lm[8].y < lm[6].y && !thumbOpen) return "MOI üë§";

                // D√âSOL√â (Poing ferm√©)
                if (fingers === 0 && !thumbOpen) return "D√âSOL√â ‚úä";

                // AIMER (Main ouverte sur le c≈ìur)
                // Diff√©rent de Bonjour car c'est en bas
                if (fingers >= 4) return "AIMER ‚ù§Ô∏è";
            }

            return null;
        }

        // Utilitaires Math√©matiques
        function countFingers(lm) {
            let count = 0;
            if (lm[8].y < lm[6].y) count++;  // Index
            if (lm[12].y < lm[10].y) count++; // Majeur
            if (lm[16].y < lm[14].y) count++; // Annulaire
            if (lm[20].y < lm[18].y) count++; // Petit doigt
            return count;
        }

        function isThumbOpen(lm) {
            // √âcartement X entre le bout du pouce et son articulation
            return Math.abs(lm[4].x - lm[2].x) > 0.05;
        }

        function display(word) {
            if (!word) {
                if(Date.now() - detectionStart > 200) {
                    wordOut.innerText = "...";
                    bubbleBox.style.borderColor = "#3b82f6";
                }
                return;
            }

            if (word === lastDetected) {
                const dur = Date.now() - detectionStart;
                wordOut.innerText = word;
                if (dur > HOLD_TIME) {
                    bubbleBox.style.borderColor = "#10b981"; // Vert
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            } else {
                lastDetected = word;
                detectionStart = Date.now();
                wordOut.innerText = word;
                bubbleBox.style.borderColor = "#3b82f6"; // Bleu
            }
        }

        // 3. CAM√âRA BASSE R√âSOLUTION (Le secret des FPS)
        async function startCamera() {
            try {
                // On demande du 240p pour l'IA (tr√®s rapide)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "user",
                        width: { ideal: 320 }, 
                        height: { ideal: 240 } 
                    }
                });
                
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();

                // On configure le canvas invisible √† la taille r√©duite
                canvas.width = 320;
                canvas.height = 240;

                loop();
            } catch (err) {
                alert("Erreur Cam√©ra: " + err.name);
            }
        }

        async function loop() {
            // On dessine la vid√©o dans le canvas invisible pour l'IA
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // L'IA analyse l'image r√©duite
            await hands.send({image: canvas});
            
            requestAnimationFrame(loop);
        }

        startCamera();
    </script>
</body>
</html>